/*!
 * AjaxFile.js
 * Project repository: https://github.com/fpellet/jquery.ajaxFile
 * Licensed under the MIT license
 */
!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):window.AjaxFile=t("undefined"!=typeof jQuery?jQuery:window.Zepto)}(function(t){"use strict";var e;!function(t){t.send=function(t){t=s(t);var e=new u(t);return e.initialize(),e.submit()}}(e||(e={}));var r,n=function(){function e(e,r){var n=t.Deferred();this.promise=n.promise(),this.abordCallback=e,r(function(t){return n.resolve(t)},function(t){return n.reject(t)})}return e.prototype.then=function(t,e){return this.promise=this.promise.then(t,e),this},e.prototype.done=function(t){return this.promise=this.promise.done(t),this},e.prototype.fail=function(t){return this.promise=this.promise.fail(t),this},e.prototype.always=function(t){return this.promise=this.promise.always(t),this},e.prototype.abord=function(){this.abordCallback||this.abordCallback()},e}();!function(e){var r=function(){function e(t){this.option=t}return e.prototype.initialize=function(){this.formFragment=o(this.option),this.htmlHack=a(this.formFragment.fragment)},e.prototype.submit=function(t){var e=this.formFragment.iframe;e.on("load",t),this.formFragment.form.submit()},e.prototype.isUninitialized=function(){var t=s(this.formFragment.iframe).readyState;return t&&"uninitialized"==t.toLowerCase()},e.prototype.getResponseDocument=function(){var t=s(this.formFragment.iframe);if(!t)throw"server abort";var e=this.formFragment.iframe.attr("origineSrc");return new c(t,e)},e.prototype.abord=function(){n(this.formFragment.iframe)},e.prototype.dispose=function(){this.htmlHack&&(t(this.htmlHack).remove(),this.htmlHack=null),this.formFragment=null,this.option=null},e}(),n=function(t){try{var e=t[0],r=e.contentWindow.document;r.execCommand&&r.execCommand("Stop")}catch(n){}t.attr("src",t.attr("origineSrc"))},o=function(e){var r=document.createDocumentFragment(),n=u(),o=f(n,p()),i=d(e,n),a=t("<div></div>");return a.hide(),a.append(o),a.append(i),r.appendChild(a[0]),{fragment:r,form:i,iframe:o}},a=function(t){return document.getElementsByTagName("body")[0].appendChild(t)},s=function(t){var e=t[0];try{if(e.contentWindow)return e.contentWindow.document}catch(r){}try{return e.contentDocument?e.contentDocument:e.document}catch(r){}return e.document},u=function(){return"jqFormIO"+(new Date).getTime()},f=function(e,r){var n=t('<iframe name="'+e+'"></iframe>'),o=r?"javascript:false":"about:blank";return n.attr("src",o),n.attr("origineSrc",o),n},d=function(e,r){var n=t("<form></form>");return n.attr("method",e.method),n.attr("action",e.url),n.attr("target",r),n.attr("encoding","multipart/form-data"),n.attr("enctype","multipart/form-data"),"GET"==e.method.toLowerCase()?v(n,e):y(n,e),m(n,e.files),n},m=function(e,r){t.each(r,function(t,r){h(e,r)})},h=function(e,r){var n=t(r.element);n.replaceWith(n.clone(!0,!0)),e.append(r.element)},l=function(t){return-1!=t.indexOf("?")},v=function(e,r){var n=t.param(r.data),o=r.url+(l(r.url)?"&":"?")+n;return e.attr("action",o),e},y=function(e,r){e.attr("action",r.url);var n=i.convert(r.data);return t.each(n,function(r,n){var o=t('<input type="hidden" />');o.attr("name",n.name),o.val(n.value),o.appendTo(e)}),e};e.createForm=function(t){var e=new r(t);return e.initialize(),e}}(r||(r={}));var o;!function(t){t[t.Json=0]="Json",t[t.Xml=1]="Xml",t[t.Text=2]="Text"}(o||(o={}));var i,a={data:{},files:[],desiredResponseDataType:o.Json,method:"POST",timeoutInSeconds:60},s=function(e){return e=t.extend(!0,{},a,e),e.url||(e.url=m()),e},u=function(){function t(t){this.option=t}return t.prototype.initialize=function(){this.form=r.createForm(this.option)},t.prototype.submit=function(){var t=this,e=new n(function(){return t.abord()},function(e,r){t.successCallback=e,t.errorCallback=r});if(setTimeout(function(){return t.send()},10),this.option.timeoutInSeconds){var r=1e3*this.option.timeoutInSeconds;this.timeoutHandle=setTimeout(function(){return t.onTimeout()},r)}return e.always(function(){return t.dispose()})},t.prototype.send=function(){var t=this;if(!this.isCompleted)try{this.form.submit(function(){return t.onStateUpdated()})}catch(e){this.onError("error",e)}},t.prototype.onStateUpdated=function(){var t=this;if(!this.isCompleted){try{var e=this.form.getResponseDocument();if(!e)return void this.abord("server abort");if(!e.isLoaded())return void setTimeout(function(){return t.onStateUpdated()},250);e.readResponse(this.option.desiredResponseDataType,this.successCallback,this.errorCallback)}catch(r){this.onError("error",r)}this.isCompleted=!0}},t.prototype.onTimeout=function(){this.abord("timeout")},t.prototype.abord=function(t){this.isCompleted||(this.isCompleted=!0,this.form.abord(),this.onError(t||"cancelled"))},t.prototype.onError=function(t,e,r){this.errorCallback({status:e,data:r,error:t}),this.dispose()},t.prototype.dispose=function(){this.isCompleted=!0,this.form&&(this.form.dispose(),this.form=null),this.timeoutHandle&&(clearTimeout(this.timeoutHandle),this.timeoutHandle=null)},t}(),c=function(){function e(t,e){this.document=t,this.origineUrl=e}return e.prototype.isLoaded=function(){return this.hrefHasChanged()?this.isXml()?!0:null!==this.document.body&&!!this.document.body.innerHTML:!1},e.prototype.hrefHasChanged=function(){return this.document.location.href!=this.origineUrl},e.prototype.isXml=function(){return this.document.XMLDocument||t.isXMLDoc(this.document)},e.prototype.readResponse=function(t,e,r){var n=this.searchContainer(),o=f(n),i=d(n.val(),t);try{o.isSuccess?e({status:o,data:i}):r({status:o,data:i,error:"server error"})}catch(a){r({status:o,data:i,error:a})}},e.prototype.searchContainer=function(){var e=this.document.getElementsByTagName("textarea")[0];if(!e)throw"Cannot find textarea in response";return t(e)},e}(),f=function(t){var e={code:200,text:"",isSuccess:!0};if(t){var r=Number(t.attr("statusCode"))||e.code;e.code=r,e.text=t.attr("statusText")||e.text,e.isSuccess=r>=200&&300>r||304===r}return e},d=function(e,r){if(r==o.Text)return e;if(r==o.Json)return t.parseJSON(e);if(r==o.Xml){var n=t.parseXML(e);if("parsererror"===n.documentElement.nodeName)throw"parsererror";return n}throw"Invalid datatype : "+r},m=function(){var t=window.location.href;return(t.match(/^([^#]+)/)||[])[1]},p=function(){return h(window.location.href)},h=function(t){return/^https/i.test(t||"")};!function(t){var e=function(t,e,n){if(e)for(var o in e){var i=e[o];i&&r(t,o,e[o],n)}},r=function(t,r,n,o){var i=o?o+"["+r+"]":r,a=Object.prototype.toString.call(n);return"[object Array]"===a?void n.forEach(function(r,n){e(t,r,i+"["+n+"]")}):"[object Object]"==a?void e(t,n,i):void t.push({name:i,value:n+""})};t.convert=function(t){var r=[];return e(r,t),r}}(i||(i={}));var l;!function(){var r=function(e,r,n){var o=t.Deferred(),i=v;return i.send(n,g(null,r,n,e)),e.then(function(t){var a=g(t,r,n,e);o.resolve(t.data,t.status&&t.status.text,a),i.success(n,a)}).fail(function(t){var a=g(t,r,n,e);o.reject(a,t.status&&t.status.text,t.error),i.error(n,a,t.error)}),r.error&&o.fail(r.error),r.success&&o.done(r.success),r.complete&&o.always(r.complete),o},n=function(e){var r=b(e),n=b(t.ajaxSettings);return t.extend(!0,{},n,a,r)};t.fn.ajaxWithFile=function(t){var o=n(t),i=e.send(o);return r(i,t,o)}}(l||(l={}));var v;!function(e){e.send=function(e,r){0===t.active++&&n(e,"ajaxStart"),n(e,"ajaxSend",[r,e])},e.error=function(t,e,o){n(t,"ajaxError",[e,t,o]),r(t,e)},e.success=function(t,e){n(t,"ajaxSuccess",[e,t]),r(t,e)};var r=function(e,r){n(e,"ajaxComplete",[r,e]),--t.active||n(e,"ajaxStop")},n=function(e,r,n){e.global&&t.event.trigger(r,n)}}(v||(v={}));var y=function(t){return t=t&&t.toLowerCase(),"xml"==t?o.Xml:"text"==t?o.Text:o.Json},b=function(t){return{method:t.type,url:t.url,data:t.data,files:t.files,desiredResponseDataType:y(t.dataType),timeoutInSeconds:1e4*(t.timeout||0)}},g=function(t,e,r,n){t=t||{};var i=t.status;return{readyState:0,status:i&&i.code||0,statusText:i&&i.text||"n/a",responseXML:r.desiredResponseDataType==o.Xml?t.data:null,responseText:r.desiredResponseDataType==o.Text?t.data:null,abort:function(){n.abord()},setRequestHeader:function(){throw"not supported"},getAllResponseHeaders:function(){return""},getResponseHeader:function(t){return"content-type"==t.toLowerCase()?e.dataType:void 0}}};return e});