/*!
 * AjaxFile.js - V0.0.4
 * Project repository: https://github.com/fpellet/jquery.ajaxFile
 * Licensed under the MIT license
 */
!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):window.AjaxFile=t("undefined"!=typeof jQuery?jQuery:window.Zepto)}(function(t){"use strict";function e(t){var e=(document.cookie.match("(^|; )"+t+"=([^;]*)")||0)[2];return decodeURIComponent(e)||null}function n(t){return-1!==document.cookie.indexOf(t+"=")}function r(t){document.cookie=t+"=; expires=Thu, 01 Jan 1970 00:00:01 GMT;"}function o(e){return e=t.extend(!0,{},C,e),e.url||(e.url=f()),e}function i(){return"ajaxFile"+(new Date).getTime()}function a(t){return{read:function(){throw t}}}function s(t){return{read:function(e){var n=c(t,e);return{status:u(),data:n}}}}function u(t){var e={code:200,text:"OK",isSuccess:!0};if(t){var n=Number(t.attr("statusCode"))||e.code;e.code=n,e.text=t.attr("statusText")||e.text,e.isSuccess=n>=200&&300>n||304===n}return e}function c(e,n){if(!e)return null;switch(n){case h.Text:return e;case h.Json:return t.parseJSON(e);case h.Xml:var r=t.parseXML(e);if("parsererror"===r.documentElement.nodeName)throw"parsererror";return r;default:throw"Invalid datatype : "+n}}function f(){var t=window.location.href;return(t.match(/^([^#]+)/)||[])[1]}function d(){return p(window.location.href)}function p(t){return/^https/i.test(t||"")}var h;!function(t){t[t.Json=0]="Json",t[t.Xml=1]="Xml",t[t.Text=2]="Text"}(h||(h={}));var l,m={send:function(t){t=o(t);var e=new x(t);return e.initialize(),e.submit()}},v=function(){function e(e,n){var r=t.Deferred();this.promise=r.promise(),this.abordCallback=e,n(function(t){return r.resolve(t)},function(t){return r.reject(t)})}return e.prototype.then=function(t,e){return this.promise=this.promise.then(t,e),this},e.prototype.done=function(t){return this.promise=this.promise.done(t),this},e.prototype.fail=function(t){return this.promise=this.promise.fail(t),this},e.prototype.always=function(t){return this.promise=this.promise.always(t),this},e.prototype.abord=function(){this.abordCallback||this.abordCallback()},e}(),y=function(){function t(t){this.cookieName=t}return t.prototype.onReceived=function(t,e,n){var r=this;this.receivedCallback=n,setTimeout(function(){return r.checkCookie()},100)},t.prototype.checkCookie=function(){var t=this;if(!this.disposed){if(!n(this.cookieName))return void setTimeout(function(){return t.checkCookie()},100);var r=e(this.cookieName),o=s(r);this.receivedCallback(o)}},t.prototype.dispose=function(){this.disposed=!0,r(this.cookieName),this.receivedCallback=null},t}();!function(e){function n(t){try{var e=t[0],n=e.contentWindow.document;n.execCommand&&n.execCommand("Stop")}catch(r){}t.attr("src",t.attr("origineSrc"))}function r(e,n){e.data.__requestId=n;var r=a(n,d()),o=s(e,n),i=t("<div></div>");return i.hide(),i.append(r),i.append(o),{container:i,form:o,iframe:r}}function o(t){t.container.appendTo("body")}function i(t){var e=t[0];try{if(e.contentWindow)return e.contentWindow.document}catch(n){}try{return e.contentDocument?e.contentDocument:e.document}catch(n){}return e.document}function a(e,n){var r=t('<iframe name="'+e+'"></iframe>'),o=n?"javascript:false":"about:blank";return r.attr("src",o),r.attr("origineSrc",o),r}function s(e,n){var r=t("<form></form>");return r.attr("method",e.method),r.attr("action",e.url),r.attr("target",n),r.attr("encoding","multipart/form-data"),r.attr("enctype","multipart/form-data"),"GET"===e.method.toLowerCase()?p(r,e):h(r,e),u(r,e.files),r}function u(e,n){t.each(n,function(t,n){c(e,n)})}function c(e,n){var r=t(n.element);r.replaceWith(r.clone(!0,!0)),r.attr("name",n.name),r.off(),e.append(n.element)}function f(t){return-1!==t.indexOf("?")}function p(e,n){var r=t.param(n.data),o=n.url+(f(n.url)?"&":"?")+r;return e.attr("action",o),e}function h(e,n){e.attr("action",n.url);var r=b.convert(n.data);return t.each(r,function(n,r){var o=t('<input type="hidden" />');o.attr("name",r.name),o.val(r.value),o.appendTo(e)}),e}function l(t,e){var n=new m(t);return n.initialize(e),n}var m=function(){function t(t){this.option=t}return t.prototype.initialize=function(t){this.addRequestIdInData(t),this.formFragment=r(this.option,t),o(this.formFragment)},t.prototype.addRequestIdInData=function(t){this.option.data.__requestId=t},t.prototype.onLoaded=function(t){var e=this.formFragment.iframe;e.on("load",t)},t.prototype.submit=function(){this.formFragment.form.submit()},t.prototype.getResponseDocument=function(){var t=i(this.formFragment.iframe);if(!t)throw"server abort";var e=this.formFragment.iframe.attr("origineSrc");return new w(t,e)},t.prototype.abord=function(){n(this.formFragment.iframe)},t.prototype.dispose=function(){this.formFragment&&(this.formFragment.container.remove(),this.formFragment=null)},t}();e.createForm=l}(l||(l={}));var b,g=function(){function t(){}return t.prototype.onReceived=function(t,e,n){var r=this;this.form=e,this.form.onLoaded(function(){return r.onStateUpdated()}),this.receivedCallback=n},t.prototype.onStateUpdated=function(){var t=this;try{var e=this.form.getResponseDocument();if(!e)return void this.receivedCallback(a("server abort"));if(!e.isLoaded())return void setTimeout(function(){return t.onStateUpdated()},250);this.receivedCallback(e)}catch(n){this.receivedCallback(a(n))}},t.prototype.dispose=function(){this.form&&(this.form.dispose(),this.form=null),this.receivedCallback=null},t}(),C={data:{},files:[],desiredResponseDataType:h.Json,method:"POST",timeoutInSeconds:60},T=function(){function t(t){var e=new y(t);this.handlers=[new k,new g,e]}return t.prototype.onReceived=function(t,e,n){this.handlers.forEach(function(r){r.onReceived(t,e,n)})},t.prototype.dispose=function(){this.handlers.forEach(function(t){t.dispose()})},t}(),x=function(){function t(t){this.option=t,this.id=i(),this.responseHandler=new T(this.id)}return t.prototype.initialize=function(){this.form=l.createForm(this.option,this.id)},t.prototype.submit=function(){var t=this,e=new v(function(){return t.abord()},function(e,n){t.successCallback=e,t.errorCallback=n});return setTimeout(function(){return t.send()},10),e.always(function(){return t.dispose()})},t.prototype.send=function(){var t=this;if(!this.isCompleted){this.responseHandler.onReceived(this.option,this.form,function(e){return t.onResponseReceived(e)});try{this.form.submit()}catch(e){this.onError("error",e)}}},t.prototype.onResponseReceived=function(t){if(!this.isCompleted){try{var e=t.read(this.option.desiredResponseDataType);e.status.isSuccess?this.successCallback(e):this.errorCallback(e)}catch(n){this.onError("error",n)}this.isCompleted=!0}},t.prototype.abord=function(t){this.onError(t||"cancelled")},t.prototype.onError=function(t,e,n){this.isCompleted||(this.isCompleted=!0,this.form.abord(),this.errorCallback({status:e,data:n,error:t}))},t.prototype.dispose=function(){this.isCompleted=!0,this.form&&(this.form.dispose(),this.form=null),this.responseHandler&&(this.responseHandler.dispose(),this.responseHandler=null)},t}(),w=function(){function e(t,e){this.document=t,this.origineUrl=e}return e.prototype.isLoaded=function(){return this.hrefHasChanged()?this.isXml()?!0:null!==this.document.body&&!!this.document.body.innerHTML:!1},e.prototype.hrefHasChanged=function(){return this.document.location.href!==this.origineUrl},e.prototype.isXml=function(){return this.document.XMLDocument||t.isXMLDoc(this.document)},e.prototype.read=function(t){var e=this.searchContainer(),n=u(e),r=c(e.val(),t);return{status:n,data:r}},e.prototype.searchContainer=function(){var e=this.document.getElementsByTagName("textarea")[0];if(!e)throw"Cannot find textarea in response";return t(e)},e}(),k=function(){function t(){}return t.prototype.onReceived=function(t,e,n){if(this.dispose(),t.timeoutInSeconds){var r=1e3*t.timeoutInSeconds;this.timeoutHandle=setTimeout(function(){n(a("Timeout"))},r)}},t.prototype.dispose=function(){this.timeoutHandle&&(clearTimeout(this.timeoutHandle),this.timeoutHandle=null)},t}();!function(t){function e(t,e,r){if(e)for(var o in e)if(e.hasOwnProperty(o)){var i=e[o];i&&n(t,o,e[o],r)}}function n(t,n,r,o){var i=o?o+"["+n+"]":n,a=Object.prototype.toString.call(r);return"[object Array]"===a?void r.forEach(function(n,r){e(t,n,i+"["+r+"]")}):"[object Object]"===a?void e(t,r,i):void t.push({name:i,value:r+""})}function r(t){var n=[];return e(n,t),n}t.convert=r}(b||(b={})),Array.prototype.forEach||(Array.prototype.forEach=function(t,e){for(var n=0,r=this.length;r>n;++n)t.call(e,this[n],n,this)});var R;!function(e){function n(n,r,o){var i=t.Deferred(),a=e.JQueryEventTrigger;return a.send(o,e.generateJqueryXHR(null,r,o,n)),n.then(function(t){var s=e.generateJqueryXHR(t,r,o,n);i.resolve(t.data,t.status&&t.status.text,s),a.success(o,s)}).fail(function(t){var s=e.generateJqueryXHR(t,r,o,n);i.reject(s,t.status&&t.status.text,t.error),a.error(o,s,t.error)}),r.error&&i.fail(r.error),r.success&&i.done(r.success),r.complete&&i.always(r.complete),i}function r(n){var r=e.convertJqueryOptionToOption(n),o=e.convertJqueryOptionToOption(t.ajaxSettings);return t.extend(!0,{},o,C,r)}t.fn.ajaxWithFile=function(t){var e=r(t),o=AjaxFile.send(e);return n(o,t,e)}}(R||(R={}));var R;!function(e){var n;!function(e){function n(e,n){0===t.active++&&a(e,"ajaxStart"),a(e,"ajaxSend",[n,e])}function r(t,e,n){a(t,"ajaxError",[e,t,n]),i(t,e)}function o(t,e){a(t,"ajaxSuccess",[e,t]),i(t,e)}function i(e,n){a(e,"ajaxComplete",[n,e]),--t.active||a(e,"ajaxStop")}function a(e,n,r){e.global&&t.event.trigger(n,r)}e.send=n,e.error=r,e.success=o}(n=e.JQueryEventTrigger||(e.JQueryEventTrigger={}))}(R||(R={}));var R;!function(t){function e(t){return t=t&&t.toLowerCase(),"xml"===t?h.Xml:"text"===t?h.Text:h.Json}function n(t){return{method:t.type,url:t.url,data:t.data,files:t.files,desiredResponseDataType:e(t.dataType),timeoutInSeconds:1e4*(t.timeout||0)}}t.convertJqueryOptionToOption=n}(R||(R={}));var R;return function(t){function e(t,e,n,r){t=t||{};var o=t.status;return{readyState:0,status:o&&o.code||0,statusText:o&&o.text||"n/a",responseXML:n.desiredResponseDataType===h.Xml?t.data:null,responseText:n.desiredResponseDataType===h.Text?t.data:null,abort:function(){r.abord()},setRequestHeader:function(){throw"not supported"},getAllResponseHeaders:function(){return""},getResponseHeader:function(t){return"content-type"===t.toLowerCase()?e.dataType:void 0}}}t.generateJqueryXHR=e}(R||(R={})),m});
//# sourceMappingURL=ajaxFile.jquery.min.js.map